{% extends 'base.html' %}
{% load static %}

{% block title %}Seguimiento de Pedidos - CorreosChile{% endblock %}

{% block content %}
<section class="public-hero public-hero-light">
  <div class="container text-center">
    <h1 class="hero-title mb-2">Seguimiento de Pedidos</h1>
    <p class="hero-subtitle mb-4">Rastrea tu env√≠o en tiempo real sin necesidad de crear una cuenta</p>
    <div class="row justify-content-center">
      <div class="col-lg-7">
        <div class="search-card p-4">
          <form method="get">
            <div class="form-row align-items-center">
              <div class="col-sm-8 mb-2 mb-sm-0">
                <input type="text" id="codigo-buscar" name="codigo" placeholder="Ingresa tu c√≥digo de seguimiento (ej: CC251122912199)" value="{{ codigo_buscado|default:'' }}" class="form-control" autocomplete="off">
                <div id="ac-list" class="list-group text-left" style="position:absolute; z-index:1060; width:100%; display:none"></div>
              </div>
              <div class="col-sm-4 text-sm-left text-center">
                <button type="submit" class="btn btn-primary btn-block btn-public-primary">üîç Buscar Pedido</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

{% if codigo_buscado %}
<section class="public-results-section">
  <div class="container">
    {% if error_busqueda %}
      <div class="alert alert-danger mb-4"><strong>‚ùå Error:</strong> {{ error_busqueda }}</div>
    {% else %}
      <div class="bg-white rounded shadow p-4 mb-4">
        <h2 class="h4 mb-3 text-dark">üìã Informaci√≥n del Pedido</h2>
        <div class="row">
          <div class="col-md-6 mb-3">
            <div class="bg-light p-3 rounded">
              <h6 class="mb-2 text-primary">C√≥digo de Seguimiento</h6>
              <p class="text-primary font-weight-bold">{{ pedido_info.codigo }}</p>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="bg-light p-3 rounded">
              <h6 class="mb-2 text-success">Estado Actual</h6>
              <span class="badge badge-pill badge-info">{{ pedido_info.estado|title }}</span>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="bg-light p-3 rounded">
              <h6 class="mb-2 text-secondary">√öltima actualizaci√≥n</h6>
              <p class="text-muted mb-0">{% if pedido_info.ultima_actualizacion %}{{ pedido_info.ultima_actualizacion|date:"d/m/Y H:i" }}{% else %}-{% endif %}</p>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="bg-light p-3 rounded">
              <h6 class="mb-2 text-secondary">Tipo de Servicio</h6>
              <p class="text-muted mb-0">{{ pedido_info.tipo_servicio }}</p>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="bg-light p-3 rounded">
              <h6 class="mb-2 text-secondary">Fecha Estimada de Entrega</h6>
              <p class="text-muted mb-0">{% if pedido_info.fecha_estimada %}{{ pedido_info.fecha_estimada|date:"d/m/Y" }}{% else %}No especificada{% endif %}</p>
            </div>
          </div>
          {% if pedido_info.estado == 'entregado' %}
          <div class="col-md-6 mb-3">
            <div class="bg-light p-3 rounded">
              <h6 class="mb-2 text-secondary">Entrega</h6>
              <p class="text-muted mb-0">{% if pedido_info.fecha_entrega_real %}{{ pedido_info.fecha_entrega_real|date:"d/m/Y H:i" }}{% else %}-{% endif %}</p>
              <small class="text-muted">Receptor: {{ pedido_info.quien_recibe|default:'-' }}</small>
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      {% if historial_items %}
      <div class="bg-white rounded shadow p-4">
        <h2 class="h4 mb-3 text-dark">üìç Historial del Pedido</h2>
        <div>
          {% for historial in historial_items %}
            <div class="d-flex align-items-start p-3 mb-2 bg-light rounded">
              <div class="mr-3"><span class="dot-blue"></span></div>
              <div class="flex-fill w-100">
                <div class="d-flex justify-content-between">
                  <div>
                    <h6 class="mb-1">{{ historial.estado|title }}</h6>
                    {% if historial.ubicacion %}<p class="text-muted mb-1">üìç {{ historial.ubicacion }}</p>{% endif %}
                    {% if historial.observacion %}<p class="text-muted mb-0">üìù {{ historial.observacion }}</p>{% endif %}
                  </div>
                  <div class="text-right"><small class="text-muted">{{ historial.fecha|date:"d/m/Y H:i" }}</small></div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    {% endif %}
  </div>
</section>
{% endif %}

<section class="py-5 bg-white">
  <div class="container">
    <h2 class="h3 text-center mb-4 text-dark">üìä Estad√≠sticas de Env√≠os</h2>
    <div class="row mb-4">
      <div class="col-md-4 mb-3">
        <div class="card-gradient-gray text-white rounded shadow p-4 text-center">
          <div class="display-4 mb-2">üì¶</div>
          <h3 class="h4">{{ total_paquetes|default:'<span class="text-black">0</span>' }}</h3>
          <p class="mb-0"><span class="text-black">Total de Env√≠os</span></p>
        </div>
      </div>
      <div class="col-md-4 mb-3">
        <div class="card-gradient-green text-white rounded shadow p-4 text-center">
          <div class="display-4 mb-2">‚úÖ</div>
          <h3 class="h4">{{ paquetes_entregados|default:'<span class="text-black">0</span>' }}</h3>
          <p class="mb-0"><span class="text-black">Pedidos Entregados</span></p>
        </div>
      </div>
      <div class="col-md-4 mb-3">
        <div class="card-gradient-yellow text-white rounded shadow p-4 text-center">
          <div class="display-4 mb-2">üöö</div>
          <h3 class="h4">{{ paquetes_en_transito|default:'<span class="text-black">0</span>'}}</h3>
          <p class="mb-0"><span class="text-black">En Tr√°nsito</span></p>
        </div>
      </div>
    </div>

    {% if estados_stats %}
    <div class="bg-light rounded p-4">
      <h3 class="h5 mb-3 text-dark">üìà Distribuci√≥n por Estados</h3>
      <div>
        {% for estado in estados_stats %}
          <div class="d-flex align-items-center mb-2">
            <div class="text-muted" style="width:140px">{{ estado.estado }}</div>
            <div class="flex-fill mx-3">
              <div class="progress" style="height: 16px;">
                <div class="progress-bar bg-info" role="progressbar" data-pct="{{ estado.porcentaje }}" aria-valuenow="{{ estado.porcentaje }}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
            </div>
            <div class="text-muted" style="width:60px;text-align:right">{{ estado.porcentaje }}%</div>
          </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
</section>

<section class="py-5 bg-light">
  <div class="container">
    <h2 class="h3 text-center mb-4 text-dark">‚ùì ¬øC√≥mo funciona?</h2>
    <div class="row">
      <div class="col-md-4 mb-3 text-center">
        <div class="step-circle mx-auto mb-3 d-flex align-items-center justify-content-center"><span class="h4 mb-0">1Ô∏è‚É£</span></div>
        <h3 class="h5 mb-2">Ingresa tu c√≥digo</h3>
        <p class="text-muted">Escribe el c√≥digo de seguimiento que recibiste al realizar tu env√≠o</p>
      </div>
      <div class="col-md-4 mb-3 text-center">
        <div class="step-circle mx-auto mb-3 d-flex align-items-center justify-content-center"><span class="h4 mb-0">2Ô∏è‚É£</span></div>
        <h3 class="h5 mb-2">Consulta el estado</h3>
        <p class="text-muted">Visualiza en tiempo real el estado actual de tu pedido</p>
      </div>
      <div class="col-md-4 mb-3 text-center">
        <div class="step-circle mx-auto mb-3 d-flex align-items-center justify-content-center"><span class="h4 mb-0">3Ô∏è‚É£</span></div>
        <h3 class="h5 mb-2">Sigue el recorrido</h3>
        <p class="text-muted">Conoce el historial completo de movimientos de tu env√≠o</p>
      </div>
    </div>
  </div>
</section>

<section class="public-footer text-white py-4">
  <div class="container text-center">
    <h3 class="h5 mb-2">üìû ¬øNecesitas ayuda?</h3>
    <p class="mb-3">Contacta a nuestro equipo de atenci√≥n al cliente</p>
    <div class="row justify-content-center">
      <div class="col-auto">
        <p class="font-weight-semibold mb-1">Tel√©fono:</p>
        <p class="mb-0">600 600 2020</p>
      </div>
      <div class="col-auto ml-4">
        <p class="font-weight-semibold mb-1">Horario:</p>
        <p class="mb-0">Lunes a Viernes 8:00 - 20:00</p>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded',function(){
  document.querySelectorAll('.progress-bar[data-pct]').forEach(function(el){
    var pct = Number(el.getAttribute('data-pct'));
    if(!isNaN(pct)) el.style.width = pct + '%';
  });
  var input = document.getElementById('codigo-buscar');
  var list = document.getElementById('ac-list');
  var t;
  function hide(){ list.style.display='none'; list.innerHTML=''; }
  function show(items){
    list.innerHTML = items.map(function(it){
      return '<a href="#" class="list-group-item list-group-item-action" data-code="'+it.codigo+'">'+it.titulo+' <small class="text-muted">'+it.sub+' ‚Ä¢ '+it.estado+'</small></a>';
    }).join('');
    list.style.display = items.length ? 'block' : 'none';
    list.querySelectorAll('a').forEach(function(a){
      a.addEventListener('click', function(e){
        e.preventDefault();
        input.value = this.getAttribute('data-code');
        hide();
      });
    });
  }
  input.addEventListener('input', function(){
    var q = this.value.trim();
    if(t) clearTimeout(t);
    if(q.length < 3){ hide(); return; }
    t = setTimeout(function(){
      fetch('/paquetes/api/busqueda-ajax/', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({query:q})})
        .then(function(r){return r.json()})
        .then(function(data){ show(data.resultados||[]); })
        .catch(function(){ hide(); });
    }, 200);
  });
  document.addEventListener('click', function(e){ if(!list.contains(e.target) && e.target !== input){ hide(); } });
});
</script>
{% endblock %}

{% block extra_css %}<link rel="stylesheet" href="{% static 'paquetes/public.css' %}">{% endblock %}
