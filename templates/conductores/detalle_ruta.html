{% extends 'base.html' %}
{% load static %}

{% block title %}Detalle Ruta - {{ ruta.nombre_ruta }} - CorreosChile{% endblock %}

{% block extra_css %}<link rel="stylesheet" href="{% static 'css/conductores_dashboard.css?v=2' %}">{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header de la Ruta -->
    <div class="ruta-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2><i class="fas fa-route"></i> {{ ruta.nombre_ruta }}</h2>
                <p class="mb-2">Fecha: {{ ruta.fecha_ruta|date:"d/m/Y" }}</p>
                <p class="mb-0">Conductor: {{ ruta.conductor.nombre_completo }}</p>
            </div>
            <div class="col-md-4 text-right">
                <div class="estado-badge estado-{{ ruta.estado }}">
                    {{ ruta.get_estado_display }}
                </div>
                <div class="mt-3">
                    <span class="badge badge-light">
                        {{ ruta.envios_entregados }}/{{ ruta.total_envios }} entregados
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Mapa y Estadísticas -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-map"></i> Mapa de la Ruta</h5>
                </div>
                <div class="card-body">
                    <div class="map-container">
                        <div class="text-center">
                            <i class="fas fa-map-marked-alt fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Mapa de navegación disponible en la app móvil</p>
                            <button class="btn btn-primary" onclick="abrirNavegacion()">
                                <i class="fas fa-navigation"></i> Abrir Navegación
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progreso de la Ruta -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> Progreso de la Ruta</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-3">
                            <div class="text-success">
                                <strong>{{ ruta.envios_entregados }}</strong><br>
                                <small>Entregados</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="text-warning">
                                <strong>{{ ruta.envios_pendientes }}</strong><br>
                                <small>Pendientes</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="text-danger">
                                <strong>{{ ruta.envios_fallidos }}</strong><br>
                                <small>Fallidos</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="text-info">
                                <strong>{{ ruta.progreso|floatformat:1 }}%</strong><br>
                                <small>Progreso</small>
                            </div>
                        </div>
                    </div>
                    <div class="progress progress-custom">
                        <div class="progress-bar bg-success" style="width: {{ ruta.progreso }}%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Información de la Ruta -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Información</h5>
                </div>
                <div class="card-body">
                    <p><strong>Hora Inicio:</strong> {{ ruta.hora_inicio|date:"H:i"|default:"No iniciada" }}</p>
                    <p><strong>Hora Fin:</strong> {{ ruta.hora_fin|date:"H:i"|default:"En progreso" }}</p>
                    <p><strong>Duración:</strong> {{ ruta.duracion|default:"N/A" }}</p>
                    <p><strong>KM Estimados:</strong> {{ ruta.kilometros_estimados|floatformat:1 }}</p>
                    <p><strong>KM Recorridos:</strong> {{ ruta.kilometros_recorridos|floatformat:1 }}</p>
                    <hr>
                    <p><strong>Prioridad:</strong> 
                        <span class="badge badge-{{ ruta.prioridad }}">
                            {{ ruta.get_prioridad_display }}
                        </span>
                    </p>
                </div>
            </div>

            <!-- Escaner QR -->
            <div class="qr-scanner">
                <h5><i class="fas fa-qrcode"></i> Escáner QR</h5>
                <p class="mb-3">Escanear códigos de envío para actualizar estados rápidamente</p>
                <button class="btn btn-light" onclick="escanearQR()">
                    <i class="fas fa-camera"></i> Escanear Código
                </button>
            </div>

            <!-- Acciones de la Ruta -->
            {% if ruta.estado == 'pendiente' %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-play"></i> Iniciar Ruta</h5>
                </div>
                <div class="card-body text-center">
                    <button class="btn btn-success btn-lg" onclick="iniciarRuta({{ ruta.id }})">
                        <i class="fas fa-play"></i> Iniciar Ruta
                    </button>
                    <p class="text-muted mt-2">Prepárate para comenzar las entregas</p>
                </div>
            </div>
            {% elif ruta.estado == 'en_progreso' %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-stop"></i> Finalizar Ruta</h5>
                </div>
                <div class="card-body text-center">
                    <button class="btn btn-danger btn-lg" onclick="finalizarRuta({{ ruta.id }})">
                        <i class="fas fa-stop"></i> Finalizar Ruta
                    </button>
                    <p class="text-muted mt-2">Marca la ruta como completada</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Lista de Envíos -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list"></i> Envíos de la Ruta ({{ envios_ruta.count }})</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for envio_ruta in envios_ruta %}
                        <div class="col-lg-6 col-xl-4">
                            <div class="envio-card {{ envio_ruta.estado }}">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0">{{ envio_ruta.envio.codigo }}</h6>
                                    <span class="badge badge-{{ envio_ruta.estado }}">
                                        {{ envio_ruta.get_estado_display }}
                                    </span>
                                </div>
                                
                                <p class="mb-2">
                                    <i class="fas fa-user"></i> {{ envio_ruta.envio.nombre_destinatario }}<br>
                                    <i class="fas fa-map-marker-alt"></i> {{ envio_ruta.envio.direccion_destino|truncatechars:40 }}
                                </p>
                                
                                <p class="mb-2">
                                    <small><strong>Teléfono:</strong> {{ envio_ruta.envio.telefono_destinatario|default:"No proporcionado" }}</small>
                                </p>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Orden: {{ envio_ruta.orden_entrega }}</small>
                                    <div>
                                        {% if envio_ruta.estado == 'pendiente' %}
                                        <button class="btn btn-success btn-action" onclick="marcarEntregado({{ envio_ruta.id }})">
                                            <i class="fas fa-check"></i> Entregado
                                        </button>
                                        <button class="btn btn-danger btn-action" onclick="marcarFallido({{ envio_ruta.id }})">
                                            <i class="fas fa-times"></i> Fallido
                                        </button>
                                        {% elif envio_ruta.estado == 'entregado' %}
                                        <button class="btn btn-info btn-action" onclick="verDetallesEntrega({{ envio_ruta.id }})">
                                            <i class="fas fa-eye"></i> Ver Detalles
                                        </button>
                                        {% elif envio_ruta.estado == 'fallido' %}
                                        <button class="btn btn-warning btn-action" onclick="reintentarEntrega({{ envio_ruta.id }})">
                                            <i class="fas fa-redo"></i> Reintentar
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function iniciarRuta(rutaId) {
    if (confirm('¿Estás seguro de iniciar esta ruta?')) {
        fetch(`/conductores/api/rutas/${rutaId}/iniciar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al iniciar la ruta');
        });
    }
}

function finalizarRuta(rutaId) {
    if (confirm('¿Estás seguro de finalizar esta ruta?')) {
        fetch(`/conductores/api/rutas/${rutaId}/finalizar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al finalizar la ruta');
        });
    }
}

function marcarEntregado(envioRutaId) {
    if (confirm('¿Marcar este envío como entregado?')) {
        fetch(`/conductores/api/envios-ruta/${envioRutaId}/entregar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                observaciones: 'Entregado exitosamente',
                firma_digital: true,
                foto_entrega: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al marcar como entregado');
        });
    }
}

function marcarFallido(envioRutaId) {
    const motivo = prompt('¿Motivo del fallo de entrega?');
    if (motivo) {
        fetch(`/conductores/api/envios-ruta/${envioRutaId}/marcar-fallido/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                motivo_fallo: motivo,
                requiere_reprogramacion: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al marcar como fallido');
        });
    }
}

function reintentarEntrega(envioRutaId) {
    if (confirm('¿Reintentar la entrega de este envío?')) {
        fetch(`/conductores/api/envios-ruta/${envioRutaId}/reintentar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al reintentar entrega');
        });
    }
}

function verDetallesEntrega(envioRutaId) {
    window.open(`/conductores/envios/${envioRutaId}/detalles/`, '_blank', 'width=600,height=400');
}

function escanearQR() {
    if (confirm('¿Abrir escáner QR? Esta función requiere acceso a la cámara.')) {
        // En una app móvil real, esto abriría la cámara para escanear
        const codigo = prompt('Simulación: Ingrese el código QR escaneado:');
        if (codigo) {
            buscarEnvioPorCodigo(codigo);
        }
    }
}

function buscarEnvioPorCodigo(codigo) {
    const envioCard = document.querySelector(`[data-codigo="${codigo}"]`);
    if (envioCard) {
        envioCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        envioCard.style.boxShadow = '0 0 20px rgba(102, 126, 234, 0.8)';
        setTimeout(() => {
            envioCard.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
        }, 3000);
    } else {
        alert('Envío no encontrado en esta ruta');
    }
}

function abrirNavegacion() {
    if (confirm('¿Abrir navegación GPS?')) {
        // En una app móvil real, esto abriría Google Maps o Waze
        alert('Función de navegación disponible en la app móvil');
    }
}

// Agregar atributos de datos para búsqueda por código
document.addEventListener('DOMContentLoaded', function() {
    const envioCards = document.querySelectorAll('.envio-card');
    envioCards.forEach(card => {
        const codigo = card.querySelector('h6').textContent.trim();
        card.setAttribute('data-codigo', codigo);
    });
});
</script>
{% endblock %}
