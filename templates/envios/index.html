{% extends 'base.html' %}
{% load static %}
{% block title %}Envíos{% endblock %}
{% block extra_css %}<link rel="stylesheet" href="{% static 'envios/style.css' %}">{% endblock %}

{% block content %}
<div class="envios-bg rounded p-3 p-md-4 mb-3">
  <div class="row metrics mb-3">
    <div class="col-md-2 mb-3">
      <div class="card text-center"><div class="card-body"><div class="h6">Total</div><div class="h3">{{ total_envios }}</div></div></div>
    </div>
    <div class="col-md-2 mb-3">
      <div class="card text-center"><div class="card-body"><div class="h6">Pendientes</div><div class="h3">{{ envios_pendientes }}</div></div></div>
    </div>
    <div class="col-md-2 mb-3">
      <div class="card text-center"><div class="card-body"><div class="h6">En tránsito</div><div class="h3">{{ envios_transito }}</div></div></div>
    </div>
    <div class="col-md-2 mb-3">
      <div class="card text-center"><div class="card-body"><div class="h6">Entregados</div><div class="h3">{{ envios_entregados }}</div></div></div>
    </div>
    <div class="col-md-2 mb-3">
      <div class="card text-center"><div class="card-body"><div class="h6">Devueltos</div><div class="h3">{{ envios_devueltos }}</div></div></div>
    </div>
    <div class="col-md-2 mb-3">
      <div class="card text-center"><div class="card-body"><div class="h6">Cancelados</div><div class="h3">{{ envios_cancelados }}</div></div></div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header d-flex align-items-center justify-content-between">
      <div>Envíos</div>
      <form class="form-inline toolbar" method="get">
        <div class="input-group mr-2">
          <div class="input-group-prepend"><span class="input-group-text">Buscar</span></div>
          <input type="text" class="form-control" name="q" value="{{ q }}" placeholder="Código, destinatario o dirección">
        </div>
        <select name="estado" class="form-control mr-2">
          <option value="" {% if not estado %}selected{% endif %}>Todos</option>
          <option value="pendiente" {% if estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
          <option value="en_transito" {% if estado == 'en_transito' %}selected{% endif %}>En tránsito</option>
          <option value="entregado" {% if estado == 'entregado' %}selected{% endif %}>Entregado</option>
          <option value="devuelto" {% if estado == 'devuelto' %}selected{% endif %}>Devuelto</option>
          <option value="cancelado" {% if estado == 'cancelado' %}selected{% endif %}>Cancelado</option>
        </select>
        <input type="text" class="form-control mr-2" name="origen" value="{{ origen }}" placeholder="Origen">
        <input type="text" class="form-control mr-2" name="destino" value="{{ destino }}" placeholder="Destino">
        <button type="submit" class="btn btn-primary mr-2">Filtrar</button>
        <a href="{% url 'envios:index' %}" class="btn btn-light">Limpiar</a>
      </form>
    </div>
      <div class="card-body">
        <div class="mb-3 p-3 border rounded">
          <form id="scan-form">
            <div class="form-row">
              <div class="col-md-3 mb-2">
                <input type="text" class="form-control" id="scan-envio" name="envio_codigo" placeholder="Código de envío">
              </div>
              <div class="col-md-7 mb-2">
                <textarea class="form-control" id="scan-codigos" name="codigos_text" rows="2" placeholder="Códigos de barras, uno por línea"></textarea>
              </div>
              <input type="hidden" id="scan-lat" name="lat">
              <input type="hidden" id="scan-lng" name="lng">
              <input type="hidden" id="scan-ubicacion" name="ubicacion">
              <div class="col-md-2 mb-2 d-flex align-items-stretch">
                <button type="button" id="scan-geo" class="btn btn-light mr-2">Ubicación</button>
                <button type="submit" class="btn btn-primary">Procesar</button>
              </div>
            </div>
            {% csrf_token %}
          </form>
          <div id="scan-result" class="mt-2"></div>
        </div>
        <div class="d-flex justify-content-end mb-2">
          <a class="btn btn-outline-secondary btn-sm mr-2" href="?q={{ q }}&estado={{ estado }}&origen={{ origen }}&destino={{ destino }}&export=csv">Exportar CSV</a>
          <a class="btn btn-outline-secondary btn-sm" href="?q={{ q }}&estado={{ estado }}&origen={{ origen }}&destino={{ destino }}&export=xls">Exportar XLS</a>
          <a class="btn btn-outline-secondary btn-sm ml-2" href="{% url 'envios:reporte_pdf' %}?q={{ q }}&estado={{ estado }}&origen={{ origen }}&destino={{ destino }}">PDF</a>
        </div>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Código</th>
                <th>Estado</th>
                <th>Origen</th>
                <th>Destino</th>
                <th>Destinatario</th>
                <th>Bultos</th>
                <th>Peso (kg)</th>
                <th>Costo</th>
                <th>Creado</th>
              </tr>
            </thead>
            <tbody>
            {% for e in envios %}
            <tr>
              <td>{{ e.codigo }}</td>
              <td>
                {% if e.estado == 'pendiente' %}
                  <span class="badge badge-warning estado-pendiente">Pendiente</span>
                {% elif e.estado == 'en_transito' %}
                  <span class="badge badge-info estado-transito">En tránsito</span>
                {% elif e.estado == 'entregado' %}
                  <span class="badge badge-success estado-entregado">Entregado</span>
                {% elif e.estado == 'devuelto' %}
                  <span class="badge badge-secondary estado-devuelto">Devuelto</span>
                {% elif e.estado == 'cancelado' %}
                  <span class="badge badge-danger estado-cancelado">Cancelado</span>
                {% else %}
                  <span class="badge badge-light">{{ e.estado }}</span>
                {% endif %}
              </td>
              <td>{{ e.origen }}</td>
              <td>{{ e.destino }}</td>
              <td>{{ e.destinatario_nombre }}</td>
              <td>{{ e.bultos.count }}</td>
              <td>{{ e.peso_kg|default:"-" }}</td>
              <td>{{ e.costo|default:"-" }}</td>
              <td>{{ e.creado_en }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="8" class="text-center">Sin datos</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <nav aria-label="Paginación">
        <ul class="pagination justify-content-end mb-0">
          {% if page_obj.has_previous %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ q }}&estado={{ estado }}&origen={{ origen }}&destino={{ destino }}">Anterior</a></li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">Anterior</span></li>
          {% endif %}

          <li class="page-item active"><span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span></li>

          {% if page_obj.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ q }}&estado={{ estado }}&origen={{ origen }}&destino={{ destino }}">Siguiente</a></li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}<script src="{% static 'envios/app.js' %}"></script>{% endblock %}