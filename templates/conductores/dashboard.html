{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard Conductor - CorreosChile{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/conductores_dashboard.css?v=1' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header del Conductor -->
    <div class="conductor-card">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2><i class="fas fa-truck"></i> Bienvenido, {{ conductor.nombre_completo }}</h2>
                <p class="mb-2">Licencia: {{ conductor.licencia_conducir }}</p>
                <p class="mb-0">Vehículo: {{ conductor.vehiculo_asignado|default:"Sin asignar" }}</p>
            </div>
            <div class="col-md-4 text-right">
                <div class="estado-badge estado-{{ conductor.estado }}">
                    {{ conductor.get_estado_display }}
                </div>
                <div class="mt-3">
                    <button class="btn btn-light btn-sm action-btn" onclick="actualizarEstado('disponible')">
                        <i class="fas fa-check"></i> Disponible
                    </button>
                    <button class="btn btn-light btn-sm action-btn" onclick="actualizarEstado('descanso')">
                        <i class="fas fa-coffee"></i> Descanso
                    </button>
                    <button class="btn btn-light btn-sm action-btn" onclick="actualizarEstado('fuera_servicio')">
                        <i class="fas fa-times"></i> Fuera Servicio
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Métricas del Día -->
    <div class="row">
        <div class="col-lg-3 col-md-6">
            <div class="metric-card">
                <div class="metric-number">{{ metricas_hoy.total_envios_entregados }}</div>
                <h5>Entregas Hoy</h5>
                <small class="text-muted">{{ metricas_hoy.eficiencia_entregas }}% eficiencia</small>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="metric-card">
                <div class="metric-number">{{ metricas_hoy.total_envios_fallidos }}</div>
                <h5>Fallos Hoy</h5>
                <small class="text-muted">{{ metricas_hoy.total_incidencias_reportadas }} incidencias</small>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="metric-card">
                <div class="metric-number">{{ metricas_hoy.total_kilometros_recorridos|floatformat:1 }}</div>
                <h5>KM Recorridos</h5>
                <small class="text-muted">Hoy</small>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="metric-card">
                <div class="metric-number">{{ metricas_hoy.puntuacion_general|floatformat:1 }}</div>
                <h5>Puntuación</h5>
                <small class="text-muted">Rendimiento general</small>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Ruta Actual -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header-custom">
                    <h5 class="mb-0"><i class="fas fa-route"></i> Ruta Actual</h5>
                </div>
                <div class="card-body">
                    {% if ruta_actual %}
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Nombre:</strong> {{ ruta_actual.nombre_ruta }}<br>
                                <strong>Estado:</strong> 
                                <span class="badge badge-{{ ruta_actual.estado }}">
                                    {{ ruta_actual.get_estado_display }}
                                </span><br>
                                <strong>Total Envíos:</strong> {{ ruta_actual.total_envios }}
                            </div>
                            <div class="col-md-6">
                                <strong>Inicio:</strong> {{ ruta_actual.hora_inicio|date:"H:i"|default:"No iniciada" }}<br>
                                <strong>Fin estimado:</strong> {{ ruta_actual.hora_fin|date:"H:i"|default:"En progreso" }}<br>
                                <strong>Progreso:</strong> {{ ruta_actual.progreso|floatformat:1 }}%
                            </div>
                        </div>
                        
                        <div class="ruta-progress mb-3">
                            <div class="ruta-progress-bar" style="width: {{ ruta_actual.progreso }}%"></div>
                        </div>
                        
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="text-success">
                                    <strong>{{ ruta_actual.envios_entregados }}</strong><br>
                                    <small>Entregados</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="text-warning">
                                    <strong>{{ ruta_actual.total_envios|radd:-ruta_actual.envios_entregados|radd:-ruta_actual.envios_fallidos }}</strong><br>
                                    <small>Pendientes</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="text-danger">
                                    <strong>{{ ruta_actual.envios_fallidos }}</strong><br>
                                    <small>Fallidos</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <a href="{% url 'conductores:detalle_ruta' ruta_actual.id %}" class="btn btn-primary">
                                <i class="fas fa-eye"></i> Ver Detalles
                            </a>
                            {% if ruta_actual.estado == 'pendiente' %}
                                <button class="btn btn-success" onclick="iniciarRuta({{ ruta_actual.id  }})">
                                    <i class="fas fa-play"></i> Iniciar Ruta
                                </button>
                            {% elif ruta_actual.estado == 'en_progreso' %}
                                <button class="btn btn-danger" onclick="finalizarRuta({{ ruta_actual.id }})">
                                    <i class="fas fa-stop"></i> Finalizar Ruta
                                </button>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-route fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No tienes rutas asignadas para hoy</p>
                            <a href="{% url 'conductores:mis_rutas' %}" class="btn btn-outline-primary">
                                Ver Mis Rutas
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Próximos Envíos -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header-custom">
                    <h5 class="mb-0"><i class="fas fa-box"></i> Próximos Envíos</h5>
                </div>
                <div class="card-body">
                    {% if envios_pendientes %}
                        {% for envio_ruta in envios_pendientes %}
                            <div class="d-flex justify-content-between align-items-center mb-3 p-2 border rounded">
                                <div>
                                    <strong>{{ envio_ruta.envio.codigo }}</strong><br>
                                    <small class="text-muted">
                                        {{ envio_ruta.envio.direccion_destino|truncatechars:30 }}
                                    </small>
                                </div>
                                <div class="text-right">
                                    <span class="badge badge-{{ envio_ruta.estado }}">
                                        {{ envio_ruta.get_estado_display }}
                                    </span><br>
                                    <small class="text-muted">#{{ envio_ruta.orden_entrega }}</small>
                                </div>
                            </div>
                        {% endfor %}
                        <div class="text-center">
                            <a href="{% if ruta_actual %}{% url 'conductores:detalle_ruta' ruta_actual.id %}{% endif %}" 
                               class="btn btn-sm btn-outline-primary">
                                Ver Todos
                            </a>
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-box fa-2x text-muted mb-2"></i>
                            <p class="text-muted">No hay envíos pendientes</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <!-- Incidencias Recientes -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header-custom">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Incidencias Recientes</h5>
                </div>
                <div class="card-body">
                    {% if incidencias_recientes %}
                        {% for incidencia in incidencias_recientes %}
                            <div class="d-flex justify-content-between align-items-center mb-3 p-2 border-left border-{{ incidencia.tipo }}">
                                <div>
                                    <strong>{{ incidencia.titulo }}</strong><br>
                                    <small class="text-muted">{{ incidencia.get_tipo_display }}</small>
                                </div>
                                <div class="text-right">
                                    <span class="badge badge-{{ incidencia.estado }}">
                                        {{ incidencia.get_estado_display }}
                                    </span><br>
                                    <small class="text-muted">{{ incidencia.fecha_reporte|date:"H:i" }}</small>
                                </div>
                            </div>
                        {% endfor %}
                        <div class="text-center">
                            <a href="{% url 'conductores:mis_incidencias' %}" class="btn btn-sm btn-outline-primary">
                                Ver Todas
                            </a>
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                            <p class="text-success">No hay incidencias reportadas hoy</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Acciones Rápidas -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header-custom">
                    <h5 class="mb-0"><i class="fas fa-bolt"></i> Acciones Rápidas</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 mb-3">
                            <a href="{% url 'conductores:crear_incidencia' %}" class="btn btn-warning btn-block action-btn">
                                <i class="fas fa-exclamation-triangle"></i><br>
                                Reportar Incidencia
                            </a>
                        </div>
                        <div class="col-6 mb-3">
                            <a href="{% url 'conductores:mi_perfil' %}" class="btn btn-info btn-block action-btn">
                                <i class="fas fa-user"></i><br>
                                Mi Perfil
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{% url 'conductores:mis_rutas' %}" class="btn btn-primary btn-block action-btn">
                                <i class="fas fa-route"></i><br>
                                Mis Rutas
                            </a>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-secondary btn-block action-btn" onclick="actualizarUbicacion()">
                                <i class="fas fa-map-marker-alt"></i><br>
                                Actualizar Ubicación
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function actualizarEstado(nuevoEstado) {
    if (confirm('¿Estás seguro de cambiar tu estado a ' + nuevoEstado + '?')) {
        fetch('{% url "conductores:actualizar_estado" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'estado=' + nuevoEstado
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al actualizar estado');
        });
    }
}

function actualizarUbicacion() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            fetch('{% url "conductores:actualizar_ubicacion" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    latitud: position.coords.latitude,
                    longitud: position.coords.longitude
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Ubicación actualizada correctamente');
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al actualizar ubicación');
            });
        }, function(error) {
            alert('No se pudo obtener la ubicación');
        });
    } else {
        alert('Geolocalización no soportada');
    }
}

function iniciarRuta(rutaId) {
    if (confirm('¿Estás seguro de iniciar esta ruta?')) {
        // Aquí iría la lógica para iniciar la ruta vía API
        alert('Función de iniciar ruta en desarrollo');
    }
}

function finalizarRuta(rutaId) {
    if (confirm('¿Estás seguro de finalizar esta ruta?')) {
        // Aquí iría la lógica para finalizar la ruta vía API
        alert('Función de finalizar ruta en desarrollo');
    }
}
</script>
{% endblock %}
